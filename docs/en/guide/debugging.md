# Debugging & Observability (Spectrum)

Gravito includes a powerful, built-in observability tool called **Spectrum**. Unlike external APM tools that require complex setup, Spectrum is designed as a native **Orbit**, meaning it integrates directly into the framework's lifecycle to capture requests, logs, and database queries in real-time.

## The Spectrum Orbit

In Gravito, infrastructure features are packaged as "Orbits". Spectrum (`@gravito/spectrum`) is the Orbit responsible for developer experience (DX) and local debugging.

### Integration Principles

Spectrum integrates with the core framework via three touchpoints:

1.  **Middleware Injection**: It injects a global middleware to intercept every HTTP request entering the `PlanetCore`.
2.  **Logger Wrapping**: It wraps the standard `core.logger`, allowing it to capture logs (`info`, `error`, etc.) and stream them to the dashboard without changing your code.
3.  **Atlas Hooks**: It automatically detects if `@gravito/atlas` is present and attaches listeners to the database connection pool to profile SQL query performance.

## Installation

```bash
bun add @gravito/spectrum
```

## Standard Integration

The recommended way to integrate Spectrum is within your application's entry point (usually `index.ts` or `app.ts`).

### Conditional Loading (Recommended)

For most applications, you only want the debug dashboard available during development.

```typescript
import { PlanetCore } from '@gravito/core'
import { SpectrumOrbit } from '@gravito/spectrum'

const core = new PlanetCore()

// Only load Spectrum in development mode
if (process.env.NODE_ENV !== 'production') {
  await core.orbit(new SpectrumOrbit())
}

await core.liftoff()
```

### Production Usage (Advanced)

If you need to use Spectrum in production (e.g., for tracing specific issues), you **must** configure a security gate to prevent unauthorized access to your debug data.

```typescript
import { SpectrumOrbit, FileStorage } from '@gravito/spectrum'

// ...

if (process.env.NODE_ENV === 'production') {
  await core.orbit(new SpectrumOrbit({
    // 1. Use FileStorage to persist data across restarts
    storage: new FileStorage({ directory: './storage/spectrum' }),
    
    // 2. Configure a Security Gate
    gate: async (c) => {
      // Only allow requests from a specific IP or with a secret header
      return c.req.header('x-spectrum-secret') === process.env.SPECTRUM_SECRET
    }
  }))
}
```

## Dashboard Features

Once running, access the dashboard at `/gravito/spectrum`.

### 1. Request Timeline
View incoming HTTP requests in real-time. Click on any request to replay it exactly as it was sentâ€”useful for reproducing bugs without manually reconstructing payloads.

### 2. Database Inspector
See the exact SQL generated by Atlas ORM, along with bindings and execution time. This helps identify N+1 queries or slow indexing issues instantly.

### 3. Log Stream
View your application logs in context. Spectrum correlates logs with the request that triggered them, so you know exactly *why* an error occurred.

## Architecture

Spectrum uses **Server-Sent Events (SSE)** to push data from the server to the dashboard UI. This eliminates the need for polling and ensures that as soon as an error happens, you see it on your screen.

Data is stored using a pluggable **Storage Driver** system:
- **MemoryStorage** (Default): Fast, zero-config, clears on restart.
- **FileStorage**: Persists data to JSONL files, useful for post-crash analysis.
