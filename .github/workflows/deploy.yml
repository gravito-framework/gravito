name: Deploy Gravito Documentation

on:
  push:
    branches:
      - main
    paths:
      - 'examples/official-site/**'
      - 'packages/**'
      - 'docs/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install
        env:
          SKIP_INSTALL_SIMPLE_GIT_HOOKS: 1

      - name: Build All Packages
        run: bun run build

      - name: Build Official Site
        working-directory: examples/official-site
        run: |
          set -e  # Exit on any error
          echo "ðŸ“¦ Current directory: $(pwd)"
          echo "ðŸ“¦ Building client assets..."
          bun run build:client
          echo "âœ… Client build completed"
          echo "ðŸ“¦ Building static site..."
          bun run build:static
          echo "âœ… Build completed"
          echo "ðŸ“¦ Checking dist-static directory..."
          if [ -d "dist-static" ]; then
            echo "âœ… dist-static directory exists"
            echo "ðŸ“¦ Contents:"
            ls -la dist-static/ | head -30
            if [ -f "dist-static/index.html" ]; then
              echo "âœ… index.html exists"
              ls -lh dist-static/index.html
            else
              echo "âŒ index.html NOT found!"
            fi
          else
            echo "âŒ dist-static directory NOT found!"
          fi
        env:
          NODE_ENV: production
          VITE_GA_ID: ${{ secrets.VITE_GA_ID }}

      - name: Verify Build Output
        working-directory: examples/official-site
        run: |
          echo "ðŸ” Verifying build output..."
          echo "Current directory: $(pwd)"
          echo "Contents of examples/official-site:"
          ls -la | head -20
          
          if [ ! -d "dist-static" ]; then
            echo "âŒ dist-static directory not found!"
            echo "Available directories:"
            ls -la
            exit 1
          fi
          
          echo "Contents of dist-static:"
          ls -la dist-static/ | head -30
          
          if [ ! -f "dist-static/index.html" ]; then
            echo "âŒ dist-static/index.html not found!"
            echo "Files in dist-static:"
            find dist-static -type f -name "*.html" | head -20
            exit 1
          fi
          
          if [ ! -f "dist-static/404.html" ]; then
            echo "âŒ dist-static/404.html not found!"
            echo "Files in dist-static:"
            find dist-static -type f -name "*.html" | head -20
            exit 1
          fi
          
          echo "âœ… Build output verified successfully"
          echo "Key files:"
          ls -lh dist-static/index.html dist-static/404.html dist-static/CNAME dist-static/.nojekyll 2>/dev/null || true

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: examples/official-site/dist-static

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
